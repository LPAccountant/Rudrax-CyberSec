from fastapi import APIRouter, Depends
from pydantic import BaseModel
from app.core.deps import get_current_user
from app.pentest.scanner import (
    port_scan, http_header_analysis, ssl_check,
    directory_bruteforce, subdomain_scan, web_vulnerability_scan
)

router = APIRouter(prefix="/api/pentest", tags=["pentest"])

class ScanRequest(BaseModel):
    target: str
    ports: str | None = None
    wordlist: list[str] | None = None
    confirmed: bool = False

@router.post("/port-scan")
async def run_port_scan(req: ScanRequest, current_user: dict = Depends(get_current_user)):
    if not req.confirmed:
        return {"warning": "You are about to scan ports on the target. Please confirm.", "requires_confirmation": True}
    result = await port_scan(req.target, req.ports or "21,22,23,25,53,80,110,143,443,993,995,3306,3389,5432,8080,8443")
    return {"tool": result.tool, "target": result.target, "results": result.results, "status": result.status, "error": result.error}

@router.post("/http-headers")
async def run_header_analysis(req: ScanRequest, current_user: dict = Depends(get_current_user)):
    if not req.confirmed:
        return {"warning": "You are about to analyze HTTP headers. Please confirm.", "requires_confirmation": True}
    result = await http_header_analysis(req.target)
    return {"tool": result.tool, "target": result.target, "results": result.results, "status": result.status, "error": result.error}

@router.post("/ssl-check")
async def run_ssl_check(req: ScanRequest, current_user: dict = Depends(get_current_user)):
    if not req.confirmed:
        return {"warning": "You are about to check SSL/TLS. Please confirm.", "requires_confirmation": True}
    result = await ssl_check(req.target)
    return {"tool": result.tool, "target": result.target, "results": result.results, "status": result.status, "error": result.error}

@router.post("/dir-bruteforce")
async def run_dir_bruteforce(req: ScanRequest, current_user: dict = Depends(get_current_user)):
    if not req.confirmed:
        return {"warning": "You are about to brute-force directories. Please confirm.", "requires_confirmation": True}
    result = await directory_bruteforce(req.target, req.wordlist)
    return {"tool": result.tool, "target": result.target, "results": result.results, "status": result.status, "error": result.error}

@router.post("/subdomain-scan")
async def run_subdomain_scan(req: ScanRequest, current_user: dict = Depends(get_current_user)):
    if not req.confirmed:
        return {"warning": "You are about to enumerate subdomains. Please confirm.", "requires_confirmation": True}
    result = await subdomain_scan(req.target)
    return {"tool": result.tool, "target": result.target, "results": result.results, "status": result.status, "error": result.error}

@router.post("/web-vuln-scan")
async def run_web_vuln_scan(req: ScanRequest, current_user: dict = Depends(get_current_user)):
    if not req.confirmed:
        return {"warning": "You are about to run a vulnerability scan. Please confirm.", "requires_confirmation": True}
    result = await web_vulnerability_scan(req.target)
    return {"tool": result.tool, "target": result.target, "results": result.results, "status": result.status, "error": result.error}
